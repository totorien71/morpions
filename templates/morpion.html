{% extends "base.html" %}

{% block titre %}Morpion{% endblock %}

{% block contenu %}
<h1>üéÆ Jeu du Morpion</h1>


<div id="score">
    <p> joueur X <span id="score X">0 </span></p>
    <p>ü§ñ Bot O : <span id="scoreO">0</span></p>
    <p>‚öñÔ∏è Nuls : <span id="scoreNul">0</span></p>
</div>

<div>
    <button onclick="choisirMode(1)">1 joueur</button>
    <button onclick="choisirMode(2)">2 joueurs</button>
    <p id="score">X : 0 | O : 0</p>
    <button onclick="resetScore()">R√©initialiser les scores</button>
</div>

<div id="plateau">
    {% for i in range(9) %}
        <div class="case" data-index="{{ i }}"></div>
    {% endfor %}
</div>

<p id="message"></p>
<button onclick="rejouer()">üîÅ Rejouer</button>

<script>
    let joueur = "X";
    let cases = Array(9).fill("");
    let modeDeJeu = 1; // 1 joueur (contre le bot) par d√©faut

    let scoreX = 0;
    let scoreO = 0;

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".case").forEach((caseElement, index) => {
            caseElement.addEventListener("click", () => {
                if (modeDeJeu === 2 || joueur === "X") {
                    jouer(index);
                }
            });
        });

        // au chargement de la page, le bot commence si c'est son tour
        if (modeDeJeu === 1 && joueur === "O") {
            setTimeout(tourDuBot, 500);
        }
    });

    function choisirMode(mode) {
        modeDeJeu = mode;
        rejouer();
    }

    function jouer(index) {
        if (cases[index] !== "" || verifierGagnant()) return;

        cases[index] = joueur;
        document.querySelectorAll(".case")[index].textContent = joueur;

        if (verifierGagnant()) {
            document.getElementById("message").textContent = "Le joueur " + joueur + " a gagn√© ! üéâ";
            if (joueur === "X") scoreX++;
            else scoreO++;
            afficherScore();
            return;
        }

        if (cases.every(c => c !== "")) {
            document.getElementById("message").textContent = "Match nul ! ü§ù";
            return;
        }

        joueur = joueur === "X" ? "O" : "X";

        if (modeDeJeu === 1 && joueur === "O") {
            setTimeout(tourDuBot, 500);
        }
    }

    function tourDuBot() {
        const combinaisons = [
            [0,1,2], [3,4,5], [6,7,8],
            [0,3,6], [1,4,7], [2,5,8],
            [0,4,8], [2,4,6]
        ];

        // Le bot essaie de gagner
        for (let combi of combinaisons){
            const [a, b, c] = combi;
            if (cases[a] === "O" && cases[b] === "O" && cases[c] === "") return jouer(c);
            if (cases[a] === "O" && cases[b] === "" && cases[c] === "O") return jouer(b);
            if (cases[a] === "" && cases[b] === "O" && cases[c] === "O") return jouer(a);
        }

        // Sinon, il bloque le joueur
        for (let combi of combinaisons){
            const [a, b, c] = combi;
            if (cases[a] === "X" && cases[b] === "X" && cases[c] === "") return jouer(c);
            if (cases[a] === "X" && cases[b] === "" && cases[c] === "X") return jouer(b);
            if (cases[a] === "" && cases[b] === "X" && cases[c] === "X") return jouer(a);
        }

        // Sinon, il joue al√©atoirement
        const casesVides = cases
            .map((val, idx) => val === "" ? idx : null)
            .filter(idx => idx !== null);

        if (casesVides.length === 0) return;

        const choix = casesVides[Math.floor(Math.random() * casesVides.length)];
        jouer(choix);
    }

    function verifierGagnant() {
        const combinaisons = [
            [0,1,2], [3,4,5], [6,7,8],
            [0,3,6], [1,4,7], [2,5,8],
            [0,4,8], [2,4,6]
        ];
        return combinaisons.some(c =>
            cases[c[0]] && cases[c[0]] === cases[c[1]] && cases[c[1]] === cases[c[2]]
        );
    }

    function rejouer() {
        cases = Array(9).fill("");
        document.querySelectorAll(".case").forEach(c => c.textContent = "");
        document.getElementById("message").textContent = "";
        joueur = "X";

        if (modeDeJeu === 1 && joueur === "O") {
            setTimeout(tourDuBot, 500);
        }
    }

    function afficherScore() {
        document.getElementById("score").textContent = `X : ${scoreX} | O : ${scoreO}`;
    }

    function resetScore() {
        scoreX = 0;
        scoreO = 0;
        afficherScore();
    }
</script>

{% endblock %}