{% extends "base.html" %}

{% block titre %}Morpion{% endblock %}

{% block contenu %}
<<h1>ðŸŽ® Jeu du Morpion</h1>

<div id="choix-mode">
    <button onclick="choisirMode('bot')">Contre le Bot</button>
    <button onclick="choisirMode('humain')">Contre un ami</button>
</div>

<div id="plateau" style="display: none;">
    {% for i in range(9) %}
        <div class="case" data-index="{{ i }}"></div>
    {% endfor %}
</div>

<p id="message"></p>

<div id="score" style="display: none;">
    Joueur X : <span id="scoreX">0</span> | Joueur O : <span id="scoreO">0</span>
</div>

<button onclick="rejouer()" id="btn-rejouer" style="display: none;">Rejouer</button>
<button onclick="resetScore()" id="btn-reset" style="display: none;">RÃ©initialiser Scores</button>
<script>
let joueur = "X";
let cases = Array(9).fill("");
let scoreX = 0;
let scoreO = 0;
let mode = ""; // 'bot' ou 'humain'
let jeuFini = false;

document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".case").forEach((caseElement, index) => {
        caseElement.addEventListener("click", () => {
            if (!jeuFini && joueur === "X") {
                jouer(index);
            } else if (!jeuFini && joueur === "O" && mode === "humain") {
                jouer(index);
            }
        });
    });
});

function choisirMode(selection) {
    mode = selection;
    document.getElementById("choix-mode").style.display = "none";
    document.getElementById("plateau").style.display = "grid";
    document.getElementById("score").style.display = "block";
    document.getElementById("btn-rejouer").style.display = "inline-block";
    document.getElementById("btn-reset").style.display = "inline-block";

    joueur = Math.random() < 0.5 ? "X" : "O";
    if (mode === "bot" && joueur === "O") {
        setTimeout(tourDuBot, 500);
    }
}

function jouer(index) {
    if (cases[index] !== "" || jeuFini) return;

    cases[index] = joueur;
    document.querySelectorAll(".case")[index].textContent = joueur;

    if (verifierGagnant()) {
        document.getElementById("message").textContent = "Le joueur " + joueur + " a gagnÃ© ! ðŸŽ‰";
        jeuFini = true;
        if (joueur === "X") scoreX++;
        else scoreO++;
        mettreAJourScore();
        return;
    }

    if (cases.every(c => c !== "")) {
        document.getElementById("message").textContent = "Match nul ! ðŸ¤";
        jeuFini = true;
        return;
    }

    joueur = joueur === "X" ? "O" : "X";

    if (mode === "bot" && joueur === "O" && !jeuFini) {
        setTimeout(tourDuBot, 500);
    }
}

function tourDuBot() {
    const combinaisons = [
        [0,1,2], [3,4,5], [6,7,8],
        [0,3,6], [1,4,7], [2,5,8],
        [0,4,8], [2,4,6]
    ];

    // StratÃ©gie intelligente
    for (let combi of combinaisons) {
        const [a, b, c] = combi;
        if (cases[a] === "O" && cases[b] === "O" && cases[c] === "") return jouer(c);
        if (cases[a] === "O" && cases[b] === "" && cases[c] === "O") return jouer(b);
        if (cases[a] === "" && cases[b] === "O" && cases[c] === "O") return jouer(a);
    }
    for (let combi of combinaisons) {
        const [a, b, c] = combi;
        if (cases[a] === "X" && cases[b] === "X" && cases[c] === "") return jouer(c);
        if (cases[a] === "X" && cases[b] === "" && cases[c] === "X") return jouer(b);
        if (cases[a] === "" && cases[b] === "X" && cases[c] === "X") return jouer(a);
    }

    const casesVides = cases
        .map((val, idx) => val === "" ? idx : null)
        .filter(idx => idx !== null);

    if (casesVides.length === 0) return;

    const choix = casesVides[Math.floor(Math.random() * casesVides.length)];
    jouer(choix);
}

function verifierGagnant() {
    const combinaisons = [
        [0,1,2], [3,4,5], [6,7,8],
        [0,3,6], [1,4,7], [2,5,8],
        [0,4,8], [2,4,6]
    ];
    return combinaisons.some(c =>
        cases[c[0]] && cases[c[0]] === cases[c[1]] && cases[c[1]] === cases[c[2]]
    );
}

function rejouer() {
    cases = Array(9).fill("");
    document.querySelectorAll(".case").forEach(c => {
        c.textContent = "";
    });
    document.getElementById("message").textContent = "";
    jeuFini = false;
    joueur = Math.random() < 0.5 ? "X" : "O";
    if (mode === "bot" && joueur === "O") {
        setTimeout(tourDuBot, 500);
    }
}

function resetScore() {
    scoreX = 0;
    scoreO = 0;
    mettreAJourScore();
}

function mettreAJourScore() {
    document.getElementById("scoreX").textContent = scoreX;
    document.getElementById("scoreO").textContent = scoreO;
}
</script>

{% endblock %}